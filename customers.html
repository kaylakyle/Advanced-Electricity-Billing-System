<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ElectroFlow - Customers</title>
  <link rel="stylesheet" href="customers.css">
  <link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">

  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="style.css">
  
</head>
<body>
  <script>
// Redirect to login if not logged in
if(!localStorage.getItem("username") || !localStorage.getItem("userRole")) {
    window.location.href = "login.html";
}
</script>

  <!-- Sidebar  -->
  <aside class="sidebar">
    <div class="logo">
      <i data-lucide="bolt"></i>
      <div>
        <h2>ElectroFlow</h2>
        <p>Billing Dashboard</p>
      </div>
    </div>
    <!-- <aside class="sidebar">
  <div class="logo">
    <div class="brand-title">ElectroFlow</div>
    <div class="brand-sub">Billing Dashboard</div>
  </div> -->

  <ul class="menu">
    <li class="active"><a href="index.html"><i class="ri-dashboard-line"></i> Overview</a></li>
    <li><a href="customers.html"><i class="ri-user-3-line"></i> Customers</a></li>
    <li><a href="billing.html"><i class="ri-bill-line"></i> Billing</a></li>
    <li><a href="payment.html"><i class="ri-bank-card-line"></i> Payments</a></li>
    <li><a href="report.html"><i class="ri-file-list-line"></i> Reports</a></li>
  </ul>
</aside>

  </aside>

  <!-- Main content  -->
  <main class="main-content">
    <header class="topbar" style="display:flex;justify-content:flex-end;align-items:center;gap:12px;">
     
      <button id="logoutBtn" class="logout" style="background:#fff;border:1px solid #e5e7eb;padding:6px 10px;border-radius:6px;display:flex;gap:6px;align-items:center;">
        <i data-lucide="log-out"></i> Logout
      </button>
    </header>

    <hr class="divider" style="border:none;border-top:1px solid #eef2ff;margin:12px 0;">

    <h2 class="title">Customer Management</h2>
    <p class="sub">Manage customer information and accounts</p>

    <div class="card">
      <div class="card-header">
        <h3>Customer List <span id="customerCount" style="font-size:13px;color:#6b7280;margin-left:8px"></span></h3>
        <div class="actions">
          <input type="text" id="searchBox" placeholder="Search name or meter..." />
          <button id="openForm" class="btn primary"><i data-lucide="user-plus"></i> Add Customer</button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Meter Number</th>
            <th>Phone</th>
            <th>Status</th>
            <th>Balance</th>
            <th style="width:120px">Actions</th>
          </tr>
        </thead>
        <tbody id="customerTableBody">
          
        </tbody>
      </table>
    </div>
  </main>

  <!-- Add/Edit Modal -->
  <div id="customerModal" class="modal hidden" aria-hidden="true">
    <div class="modal-card">
      <h3 id="modalTitle">Add Customer</h3>
      <form id="customerForm">
        <input type="text" id="custName" placeholder="Full name" required />
        <input type="text" id="custMeter" placeholder="Meter number" required />
        <input type="text" id="custPhone" placeholder="Phone (e.g. +2547...)" />
        <div class="modal-actions">
          <button type="button" id="cancelBtn" class="btn ghost">Cancel</button>
          <button type="submit" class="btn primary" id="saveBtn">Save</button>
        </div>
      </form>
    </div>
  </div>
<script>
// Safe JSON parser 
function safeParse(data) {
  try { return JSON.parse(data) || []; } 
  catch (e) { return []; }
}

//  Load & save customers 
function loadCustomers() { return safeParse(localStorage.getItem("customers")); }
function saveCustomers(customers) { localStorage.setItem("customers", JSON.stringify(customers)); }

//  Render customers table 
function renderCustomers(customers) {
  const tbody = document.getElementById("customerTableBody");
  tbody.innerHTML = "";

  customers.forEach((cust, index) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${cust.name}</td>
      <td>${cust.meter}</td>
      <td>${cust.phone || "-"}</td>
      <td>${cust.status || "Active"}</td>
      <td>${cust.balance || "0"}</td>
      <td>
        <button class="edit-btn" data-index="${index}">Edit</button>
        <button class="delete-btn" data-index="${index}">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("customerCount").textContent = `(${customers.length})`;
}

// Modal logic 
const modal = document.getElementById("customerModal");
const openBtn = document.getElementById("openForm");
const cancelBtn = document.getElementById("cancelBtn");
const customerForm = document.getElementById("customerForm");
let editingIndex = null;

openBtn.addEventListener("click", () => {
  modal.classList.remove("hidden");
  document.getElementById("modalTitle").textContent = "Add Customer";
  customerForm.reset();
  editingIndex = null;
});

cancelBtn.addEventListener("click", () => modal.classList.add("hidden"));

//  Add / Update Customer
customerForm.addEventListener("submit", e => {
  e.preventDefault();

  const name = document.getElementById("custName").value.trim();
  const meter = document.getElementById("custMeter").value.trim();
  const phone = document.getElementById("custPhone").value.trim();

  if (!name || !meter) return alert("Enter name & meter.");

  let customers = loadCustomers();

  if (editingIndex !== null) {
    customers[editingIndex] = { name, meter, phone };
    editingIndex = null;
  } else {
    customers.push({ name, meter, phone });
  }

  saveCustomers(customers);
  renderCustomers(customers);
  modal.classList.add("hidden");
});

//  Edit / Delete buttons 
document.getElementById("customerTableBody").addEventListener("click", e => {
  const index = e.target.dataset.index;
  let customers = loadCustomers();

  if (e.target.classList.contains("edit-btn")) {
    const cust = customers[index];
    document.getElementById("custName").value = cust.name;
    document.getElementById("custMeter").value = cust.meter;
    document.getElementById("custPhone").value = cust.phone || "";
    editingIndex = index;
    document.getElementById("modalTitle").textContent = "Edit Customer";
    modal.classList.remove("hidden");
  }

  if (e.target.classList.contains("delete-btn")) {
    if (confirm("Delete this customer?")) {
      customers.splice(index, 1);
      saveCustomers(customers);
      renderCustomers(customers);
    }
  }
});

//Logout 
document.getElementById("logoutBtn").addEventListener("click", (e) => {
    e.preventDefault(); // prevent default link behavior
    // Optional: clear session/login info if stored
    // localStorage.removeItem("loggedInUser"); 
    window.location.href = "login.html"; // redirect to login page
});


//  Search 
document.getElementById("searchBox").addEventListener("input", e => {
  const query = e.target.value.toLowerCase();
  const filtered = loadCustomers().filter(c =>
    c.name.toLowerCase().includes(query) || c.meter.toLowerCase().includes(query)
  );
  renderCustomers(filtered);
});

//  Init 
document.addEventListener("DOMContentLoaded", () => {
  renderCustomers(loadCustomers());
});

const logoutBtn = document.getElementById("logoutBtn");
if(logoutBtn){
    logoutBtn.addEventListener("click", (e)=>{
        e.preventDefault();
        // Remove login info
        localStorage.removeItem("username");
        localStorage.removeItem("userRole");
        // Redirect to login
        window.location.href = "login.html";
    });
}

</script>

</body>
</html>
